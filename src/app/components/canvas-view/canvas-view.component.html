<div class="canvas-container">
  <!-- Floating Controls Container -->
  <div class="floating-controls-wrapper" 
       [class.active]="isViewerMode || isCompactUI" 
       [class.floating-normal]="!isViewerMode && !isCompactUI"
       *ngIf="showControls">
    <!-- Left: Content Type Split Button (Compact UI or Viewer with controls) -->
    <div class="floating-content-type-split" *ngIf="isCompactUI || isViewerMode">
      <div class="split-button-container">
        <!-- Left side: Content Type Display -->
        <div class="split-button-main">
          <mat-icon>category</mat-icon>
          <span>{{ getContentTypeLabel() }}</span>
        </div>
        
        <!-- Right side: Dropdown Button -->
        <button 
          mat-button
          [matMenuTriggerFor]="contentTypeMenuFloating"
          [disabled]="state.isExtracting"
          class="split-button-dropdown">
          <mat-icon>expand_more</mat-icon>
        </button>
      </div>
      
      <!-- Material Menu -->
      <mat-menu #contentTypeMenuFloating="matMenu" class="content-type-menu">
        <button 
          mat-menu-item 
          *ngFor="let option of contentTypeOptions"
          (click)="selectContentType(option)"
          [class.active]="getContentTypeLabel() === option.label">
          <span>{{ option.label }}</span>
          <mat-icon *ngIf="getContentTypeLabel() === option.label" class="checkmark">check</mat-icon>
        </button>
      </mat-menu>
    </div>
    
    <!-- Right: Action Buttons -->
    <div class="floating-action-buttons">
      <app-json-loader (jsonLoaded)="onJsonLoaded($event)"></app-json-loader>
      
      <button 
        mat-icon-button
        class="control-button save-button"
        [class.active]="canSubmit()"
        [disabled]="!canSubmit()"
        (click)="downloadJson()"
        [matTooltip]="'TOOLTIPS.DOWNLOAD_JSON' | translate">
        <mat-icon>save</mat-icon>
      </button>
      
      <button 
        mat-icon-button
        class="control-button upload-button"
        [class.active]="canSubmit()"
        [disabled]="!canSubmit()"
        (click)="submitMetadata()"
        [matTooltip]="'TOOLTIPS.SUBMIT_SUGGESTION' | translate">
        <mat-icon>cloud_upload</mat-icon>
      </button>
      
      <app-language-switcher></app-language-switcher>

      <button 
        *ngIf="integrationMode.isBrowserExtension() || integrationMode.isBookmarklet()"
        mat-icon-button
        class="control-button btn-close"
        (click)="closeCanvas()"
        [matTooltip]="'HEADER.CLOSE' | translate">
        <mat-icon>close</mat-icon>
      </button>
    </div>
  </div>

  <!-- Input Section -->
  <div class="input-section" *ngIf="!isViewerMode && !isCompactUI">
    <mat-form-field appearance="outline" class="full-width">
      <mat-label>{{ 'INPUT.PLACEHOLDER' | translate }}</mat-label>
      <textarea
        matInput
        rows="4"
        [(ngModel)]="userText"
        [disabled]="state.isExtracting"
      ></textarea>
    </mat-form-field>
      
    <div class="header-actions">
      <button 
        mat-flat-button
        class="btn-extract-filled"
        (click)="startExtraction()"
        [disabled]="state.isExtracting || !userText.trim()"
      >
        <mat-icon *ngIf="!state.isExtracting">play_arrow</mat-icon>
        <mat-icon *ngIf="state.isExtracting">hourglass_empty</mat-icon>
        <span *ngIf="!state.isExtracting">{{ 'INPUT.START_EXTRACTION' | translate }}</span>
        <span *ngIf="state.isExtracting">{{ 'INPUT.EXTRACTING' | translate }}</span>
      </button>
      
      <button 
        mat-flat-button
        class="btn-reset-tonal"
        (click)="reset()"
        [disabled]="state.isExtracting"
      >
        <mat-icon>refresh</mat-icon>
        {{ 'INPUT.RESET' | translate }}
      </button>
    </div>
  </div>

  <!-- Compact Status Bar: Content Type + Progress (only in normal mode, not in Compact UI) -->
  <div *ngIf="state.totalFields > 0 && !isViewerMode && !isCompactUI" class="compact-status-bar">
    <!-- Left: Content Type Split Button -->
    <div class="content-type-section-split">
      <div class="split-button-container">
        <!-- Left side: Content Type Display -->
        <div class="split-button-main">
          <mat-icon>category</mat-icon>
          <span>{{ getContentTypeLabel() }}</span>
        </div>
        
        <!-- Right side: Dropdown Button -->
        <button 
          mat-button
          [matMenuTriggerFor]="contentTypeMenu"
          [disabled]="state.isExtracting"
          class="split-button-dropdown">
          <mat-icon>expand_more</mat-icon>
        </button>
      </div>
      
      <!-- Material Menu -->
      <mat-menu #contentTypeMenu="matMenu" class="content-type-menu">
        <button 
          mat-menu-item 
          *ngFor="let option of contentTypeOptions"
          (click)="selectContentType(option)"
          [class.active]="getContentTypeLabel() === option.label">
          <span>{{ option.label }}</span>
          <mat-icon *ngIf="getContentTypeLabel() === option.label" class="checkmark">check</mat-icon>
        </button>
      </mat-menu>
    </div>

    <!-- Right: Progress Info -->
    <div class="progress-section-compact">
      <div class="field-stats">
        <span class="stat-item total">
          {{ 'PROGRESS.FIELDS' | translate }}: {{ state.filledFields }}/{{ state.totalFields }}
        </span>
        <span 
          class="stat-item required-badge"
          [class.required-complete]="allRequiredFieldsFilled()"
          [class.required-incomplete]="!allRequiredFieldsFilled()">
          {{ 'PROGRESS.REQUIRED' | translate }}: {{ getRequiredFieldsStatus().filled }}/{{ getRequiredFieldsStatus().total }}
        </span>
        <mat-icon class="progress-icon" [class.progress-complete]="getProgressPercentage() === 100">
          {{ getProgressIcon() }}
        </mat-icon>
      </div>
      <mat-progress-bar 
        class="progress-bar-compact"
        mode="determinate"
        [value]="state.extractionProgress"
      ></mat-progress-bar>
    </div>

  </div>

  <!-- Canvas Content Area -->
  <div class="canvas-content" *ngIf="state.fieldGroups.length > 0">
    
    <!-- All Field Groups (in schema order) -->
    <div *ngFor="let group of state.fieldGroups; trackBy: trackByGroupId" class="field-group">
      <div class="group-header">
        <h3>üìã {{ group.label }}</h3>
        <div class="group-badges">
          <span class="group-badge schema-badge">{{ group.schemaName }}</span>
          <span class="group-badge count-badge">{{ getFilledFieldsCount(group) }} / {{ getFlattenedFields(group.fields).length }}</span>
          <span class="badge-text">{{ 'PROGRESS.FIELDS_RECOGNIZED' | translate }}</span>
        </div>
      </div>
      <div class="group-fields">
        <app-canvas-field
          *ngFor="let field of getFlattenedFields(group.fields); trackBy: trackByFieldId"
          [field]="field"
          [readonly]="isReadonly"
          (fieldChange)="onFieldChange($event)"
        ></app-canvas-field>
      </div>
    </div>
  </div>

  <!-- Empty State -->
  <div *ngIf="state.fieldGroups.length === 0" class="empty-state">
    <div class="empty-state-content">
      <div class="empty-icon">üìù</div>
      <h3>{{ 'EMPTY_STATE.TITLE' | translate }}</h3>
      <p>{{ 'EMPTY_STATE.MESSAGE' | translate }}</p>
    </div>
  </div>

  <!-- Footer Section -->
  <div class="canvas-footer" *ngIf="state.totalFields > 0 && !isViewerMode">
    <div class="footer-info">
      <span>
        <strong>{{ state.filledFields }}</strong> {{ 'FOOTER.FIELDS_INFO' | translate:{ total: state.totalFields } }}
      </span>
      <div class="provider-info">{{ llmProvider }} ({{ llmModel }})</div>
    </div>
    <div class="footer-actions" [class.multi-button]="integrationMode.isBookmarklet() || integrationMode.isStandalone()">
      <!-- Bookmarklet Mode: Beide Buttons -->
      <ng-container *ngIf="integrationMode.isBookmarklet()">
        <button 
          mat-icon-button
          class="control-button save-button"
          [class.active]="allRequiredFieldsFilled()"
          [disabled]="!allRequiredFieldsFilled()"
          (click)="downloadJson()"
          [matTooltip]="allRequiredFieldsFilled() ? ('TOOLTIPS.DOWNLOAD_JSON' | translate) : ('FOOTER.REQUIRED_FIELDS_MISSING' | translate:{ filled: getRequiredFieldsStatus().filled, total: getRequiredFieldsStatus().total })"
        >
          <mat-icon>save</mat-icon>
        </button>
        
        <button 
          mat-icon-button
          class="control-button upload-button"
          [class.active]="allRequiredFieldsFilled() && !isSubmitting"
          [disabled]="!allRequiredFieldsFilled() || isSubmitting"
          (click)="submitAsGuest()"
          [matTooltip]="isSubmitting ? ('FOOTER.SUBMITTING' | translate) : allRequiredFieldsFilled() ? ('TOOLTIPS.SUBMIT_SUGGESTION' | translate) : ('FOOTER.REQUIRED_FIELDS_MISSING' | translate:{ filled: getRequiredFieldsStatus().filled, total: getRequiredFieldsStatus().total })"
        >
          <mat-icon *ngIf="!isSubmitting">cloud_upload</mat-icon>
          <mat-spinner *ngIf="isSubmitting" diameter="20"></mat-spinner>
        </button>
      </ng-container>
      
      <!-- Standalone: Beide Buttons (wie Bookmarklet) -->
      <ng-container *ngIf="integrationMode.isStandalone()">
        <button 
          mat-icon-button
          class="control-button save-button"
          [class.active]="allRequiredFieldsFilled()"
          [disabled]="!allRequiredFieldsFilled()"
          (click)="downloadJson()"
          [matTooltip]="allRequiredFieldsFilled() ? ('TOOLTIPS.DOWNLOAD_JSON' | translate) : ('FOOTER.REQUIRED_FIELDS_MISSING' | translate:{ filled: getRequiredFieldsStatus().filled, total: getRequiredFieldsStatus().total })"
        >
          <mat-icon>save</mat-icon>
        </button>
        
        <button 
          mat-icon-button
          class="control-button upload-button"
          [class.active]="allRequiredFieldsFilled() && !isSubmitting"
          [disabled]="!allRequiredFieldsFilled() || isSubmitting"
          (click)="submitAsGuest()"
          [matTooltip]="isSubmitting ? ('FOOTER.SUBMITTING' | translate) : allRequiredFieldsFilled() ? ('TOOLTIPS.SUBMIT_SUGGESTION' | translate) : ('FOOTER.REQUIRED_FIELDS_MISSING' | translate:{ filled: getRequiredFieldsStatus().filled, total: getRequiredFieldsStatus().total })"
        >
          <mat-icon *ngIf="!isSubmitting">cloud_upload</mat-icon>
          <mat-spinner *ngIf="isSubmitting" diameter="20"></mat-spinner>
        </button>
      </ng-container>
      
      <!-- Browser Extension: Ein Button -->
      <button 
        *ngIf="integrationMode.isBrowserExtension()"
        mat-icon-button
        class="control-button upload-button"
        [class.active]="allRequiredFieldsFilled() && !isSubmitting"
        [disabled]="!allRequiredFieldsFilled() || isSubmitting"
        (click)="submitAsGuest()"
        [matTooltip]="isSubmitting ? ('FOOTER.SENDING' | translate) : allRequiredFieldsFilled() ? ('TOOLTIPS.SUBMIT_SUGGESTION' | translate) : ('FOOTER.REQUIRED_FIELDS_MISSING' | translate:{ filled: getRequiredFieldsStatus().filled, total: getRequiredFieldsStatus().total })"
      >
        <mat-icon *ngIf="!isSubmitting">cloud_upload</mat-icon>
        <mat-spinner *ngIf="isSubmitting" diameter="20"></mat-spinner>
      </button>
    </div>
  </div>
</div>
