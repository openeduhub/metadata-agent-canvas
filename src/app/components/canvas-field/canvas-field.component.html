<div class="canvas-field" [ngClass]="getStatusClass()">
  <!-- Main field row -->
  <div class="main-field-row">
    <!-- Status Icon -->
    <mat-icon class="status-icon" [matTooltip]="field.status">{{ getStatusIcon() }}</mat-icon>
    
    <!-- Label -->
    <label class="field-label">
      {{ field.label }}
      <span *ngIf="field.isRequired" class="required-marker">*</span>
    </label>
    
    <!-- Input Area -->
    <div class="field-input-container">
      <!-- For parent fields with sub-fields: Show preview instead of chips -->
      <div *ngIf="field.isParent && field.subFields && field.subFields.length > 0" class="structured-field-preview">
        <span class="preview-text">{{ getStructuredPreview() }}</span>
      </div>
      
      <!-- Chips for array fields with existing values (but NOT for parent fields) -->
      <mat-chip-set *ngIf="!field.isParent && field.multiple && field.value && field.value.length > 0" class="chip-container">
        <mat-chip *ngFor="let item of field.value" [removable]="true" (removed)="removeChip(item)">
          {{ getVocabularyLabel(item) }}
          <button matChipRemove>
            <mat-icon>close</mat-icon>
          </button>
        </mat-chip>
      </mat-chip-set>
      
      <!-- Input field (hidden for parent fields) -->
      <mat-form-field *ngIf="!field.isParent" appearance="outline" class="input-wrapper">
        <textarea
          #textareaRef
          matInput
          [(ngModel)]="inputValue"
          (input)="onInput($event)"
          (blur)="onBlur()"
          (keypress)="onKeyPress($event)"
          [placeholder]="field.description"
          [disabled]="field.status === FieldStatus.EXTRACTING"
          cdkTextareaAutosize
          cdkAutosizeMinRows="1"
          [matAutocomplete]="auto"
        ></textarea>
        
        <!-- Autocomplete -->
        <mat-autocomplete #auto="matAutocomplete" (optionSelected)="selectOption($event.option.value)">
          <mat-option *ngFor="let option of filteredOptions" [value]="option">
            {{ option }}
          </mat-option>
        </mat-autocomplete>
      </mat-form-field>
    </div>
    
    <!-- Geo Button (for fields with coordinates) -->
    <button 
      *ngIf="hasGeoCoordinates()" 
      mat-icon-button
      [matTooltip]="'FIELD.SHOW_ON_MAP' | translate"
      (click)="openInOpenStreetMap()"
      type="button"
      class="geo-button"
    >
      <mat-icon>map</mat-icon>
    </button>
    
    <!-- Info Button (only for parent fields, not sub-fields) -->
    <button 
      *ngIf="field.description && !field.parentFieldId" 
      mat-icon-button
      [matTooltip]="getTooltipText()"
      type="button"
      class="info-button"
    >
      <mat-icon>info</mat-icon>
    </button>
  </div>
  
  <!-- Error Message -->
  <mat-error *ngIf="field.status === FieldStatus.ERROR && field.extractionError" class="error-message">
    {{ field.extractionError }}
  </mat-error>

  <!-- Sub-fields (for complex objects with shape) -->
  <div *ngIf="field.isParent && field.subFields && field.subFields.length > 0" class="sub-fields-tree">
    <div *ngFor="let subField of field.subFields; let isLast = last" class="sub-field-tree-row" [class.sub-field-tree-row-last]="isLast">
      <div class="tree-branch" [class.tree-branch-last]="isLast">
        <span class="tree-line-vertical"></span>
        <span class="tree-line-horizontal"></span>
      </div>

      <div class="sub-field-content">
        <mat-icon class="status-icon sub-field-status" [matTooltip]="subField.status">{{ getStatusIconForField(subField) }}</mat-icon>

        <label class="field-label sub-field-label">
          {{ subField.label }}
          <span *ngIf="subField.isRequired" class="required-marker">*</span>
        </label>

        <div class="field-input-container sub-field-input-container" [class.sub-field-disabled]="shouldDisableSubFieldInput(subField)">
          <!-- Preview for structured data (nested objects or child sub-fields) -->
          <div *ngIf="shouldShowPreview(subField)" class="structured-field-preview">
            <span class="preview-text">{{ getSubFieldPreview(subField) }}</span>
          </div>

          <mat-form-field *ngIf="!subField.isParent" appearance="outline">
            <textarea
              matInput
              [(ngModel)]="subField.value"
              (blur)="onSubFieldValueChange(subField)"
              [placeholder]="subField.description"
              [disabled]="subField.status === FieldStatus.EXTRACTING"
              cdkTextareaAutosize
              cdkAutosizeMinRows="1"
            ></textarea>
          </mat-form-field>
        </div>

        <div class="sub-field-buttons">
          <button 
            *ngIf="subFieldHasGeoCoordinates(subField)" 
            mat-icon-button
            [matTooltip]="'FIELD.SHOW_ON_MAP' | translate"
            (click)="openSubFieldInOpenStreetMap(subField)"
            type="button"
            class="geo-button sub-field-geo-button"
          >
            <mat-icon>map</mat-icon>
            <mat-icon>map</mat-icon>
          </button>

          <button
            *ngIf="subField.description"
            mat-icon-button
            [matTooltip]="getTooltipTextForSubField(subField)"
            type="button"
            class="info-button sub-field-info-button"
          >
            <mat-icon>info</mat-icon>
            <mat-icon>info</mat-icon>
          </button>
        </div>
      </div>
    </div>
  </div>
  
</div>
